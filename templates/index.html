{% extends "base.html" %}

{% block title %}Gold Prediction Pro | Obsidian Dashboard{% endblock %}

{% block header_title %}Market Intelligence Dashboard <span
    style="font-size: 0.7rem; font-family: var(--font-mono); font-weight: 300; opacity: 0.6; margin-left:10px;">DB_SYNC:
    <span id="last_db_update">--</span> <button id="force_sync_btn" class="icon-btn" title="Force DB Update"
        style="color:var(--terminal-gold);"><span class="material-symbols-outlined"
            style="font-size: 0.9rem; vertical-align: middle;">sync</span></button></span>{% endblock %}

{% block content %}

<div class="ticker-wrap">
    <div class="ticker" id="ticker_content">
        <!-- Ticker items will be injected by JS -->
        <span class="ticker-item">LOADING TERMINAL DATA...</span>
        <span class="ticker-item">CORE INDEXES: [XAU/USD] [XAG/USD] [CL/USD] [DXY] [SPX] [IXIC] [BTC] [IDR]</span>
    </div>
</div>

<div class="grid-container">
    <!-- Hero Card: Current Price -->
    <div class="card hero-card glass">
        <div class="card-header">Live Market Spot (IDR/g)</div>
        <div class="price-container">
            <span id="price_idr" class="main-price">Loading...</span>
            <span id="price_change" class="change-tag" title="Trend vs Yesterday's Close">--%</span>
        </div>
        <div class="sub-price" id="price_usd">Spot Index: $ -- / Oz</div>
    </div>

    <!-- Signal Card -->
    <div class="card signal-card glass">
        <div class="card-header">
            AI Trade Insight (Forecast)
            <div style="display: flex; align-items: center; gap: 8px;">
                <span id="signal_countdown" class="countdown-timer" title="Next AI Intelligence Refresh">00:00</span>
                <div id="signal_light" class="status-light"></div>
            </div>
        </div>
        <div id="signal_value" class="signal-value text-gold">--</div>
        <div id="target_price" class="sub-price" style="margin-top: 5px; font-weight: 600;">
            Next-Day Target: --
        </div>
        <div class="action-window" style="font-size: 0.75rem; opacity: 0.7;">
            Forecast Window Ends: <span id="action_date">--</span>
        </div>

        <!-- Executive Summary Block -->
        <div id="signal_logic_box" class="logic-summary-box">
            <span class="material-symbols-outlined" style="font-size: 1.1rem; vertical-align: middle;">info</span>
            <span id="signal_logic_text">Analyzing market conditions...</span>
        </div>
    </div>

    <!-- Sentiment Card -->
    <div class="card sentiment-card glass">
        <div class="card-header">Market Tendency (Bias)</div>
        <div class="sentiment-bar-container">
            <div id="sentiment_bar" class="sentiment-bar" style="width: 50%;"></div>
        </div>
        <div class="sentiment-labels">
            <span>Bullish: <span id="bull_ratio" class="text-gold">--%</span></span>
            <span>Bearish: <span id="bear_ratio" class="text-red">--%</span></span>
        </div>
        <div class="sentiment-score" id="sentiment_avg">Net Score: 0.00</div>
    </div>

    <!-- Spread Radar Card -->
    <div class="card spread-card glass">
        <div class="card-header">Spread Radar (Spot vs Phys)</div>
        <div class="spread-container">
            <div class="spread-item">
                <span class="label">Physical Buyback (Antam):</span>
                <span id="physical_price" class="value">Rp --</span>
            </div>
            <div class="spread-item">
                <span class="label">Live Spot (International):</span>
                <span id="spot_price" class="value">Rp --</span>
            </div>
            <div class="spread-diff" id="spread_diff">
                Price Gap: --%
            </div>
        </div>
    </div>

    <div class="card chart-card glass grid-span-2">
        <div class="card-header">
            Historical Price Trend
            <div class="timeframe-selector">
                <button class="tf-btn" data-days="30">1M</button>
                <button class="tf-btn" data-days="90">3M</button>
                <button class="tf-btn" data-days="180">6M</button>
                <button class="tf-btn active" data-days="100">ALL</button>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="historyChart"></canvas>
        </div>
    </div>

    <!-- Watchlist / Factors -->
    <div class="card factors-card glass">
        <div class="card-header">Key Risk Watchlist</div>
        <ul class="factors-list" id="risk_watchlist">
            <li><span class="dot gold"></span>
                <div><strong>Synchronizing</strong>: Analyzing market risks...</div>
            </li>
        </ul>
    </div>

    <!-- Portfolio Tracker Card -->
    <div class="card portfolio-card glass">
        <div class="card-header">
            Asset Portfolio
            <button id="edit_portfolio" class="icon-btn">
                <span class="material-symbols-outlined" style="font-size: 1.2rem;">edit</span>
            </button>
        </div>
        <div class="portfolio-stats">
            <div class="stat-item">
                <div class="label">Estimated Total Value</div>
                <div id="portfolio_value" class="value">Rp 0</div>
            </div>
            <div class="stat-item">
                <div class="label">P/L (Today's Change)</div>
                <div id="portfolio_pl" class="value">--</div>
            </div>
        </div>
        <div class="portfolio-details" id="portfolio_details">
            Current Holdings: <span id="portfolio_holdings">0</span>g @ <span id="portfolio_avg_price">Rp 0</span> Unit
            Cost
        </div>
    </div>

    <!-- Market Monitor (Terminal Style) -->
    <div class="card terminal-monitor glass grid-span-full">
        <div class="card-header">Global Market Monitor (Terminal Snapshot)</div>
        <div class="monitor-table-container" style="overflow-x: auto;">
            <table class="monitor-table" style="min-width: 500px;">
                <thead
                    style="font-family: var(--font-mono); font-size: 0.75rem; text-transform: uppercase; color: #666;">
                    <tr>
                        <th style="text-align: left;">Ticker</th>
                        <th>Last Price</th>
                        <th>Chg %</th>
                        <th>Trend (1D)</th>
                    </tr>
                </thead>
                <tbody id="monitor_body" style="font-family: var(--font-mono);">
                    <tr>
                        <td colspan="4" class="text-center">Initializing terminal feeds...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Multi-day Forecast -->
    <div class="card forecast-card glass grid-span-full">
        <div class="card-header">
            <span>Realtime AI Forecast</span>
            <div class="forecast-input">
                <label>Days:</label>
                <input type="number" id="forecast_days" value="7" min="2" max="100">
            </div>
            <!-- Simulation sliders removed -->
            <div style="flex-grow: 1;"></div>
        </div>
        <div class="forecast-table-container" style="overflow-x: auto;">
            <table class="forecast-table" style="min-width: 700px;">
                <thead>
                    <tr>
                        <th>Day Index</th>
                        <th>Forecast Date</th>
                        <th>Min Bound (IDR/g)</th>
                        <th>Max Bound (IDR/g)</th>
                        <th>Est. Average (IDR/g)</th>
                        <th>Est. Net Change</th>
                    </tr>
                </thead>
                <tbody id="forecast_body">
                    <tr>
                        <td colspan="6" class="text-center">Configure simulation and run forecast.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
</div>
</div>

<!-- Portfolio Edit Modal -->
<div id="portfolio_modal" class="overlay">
    <div class="modal-content glass">
        <h2>Manage Portfolio Holdings</h2>
        <div class="input-group">
            <label>Total Gold Owned (grams)</label>
            <input type="number" id="input_gold_amount" step="0.01" placeholder="e.g. 10.5">
        </div>
        <div class="input-group">
            <label>Avg. Purchase Price (IDR/g)</label>
            <input type="number" id="input_purchase_price" placeholder="e.g. 1200000">
        </div>
        <div class="modal-actions">
            <button id="cancel_portfolio" class="bg-grey">Cancel</button>
            <button id="save_portfolio">Save Holdings</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}?v={{ range(1, 100000) | random }}"></script>
{% endblock %}