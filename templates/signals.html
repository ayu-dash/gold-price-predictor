{% extends "base.html" %}

{% block title %}Signal Intelligence | Gold Futures Pro{% endblock %}

{% block header_title %}Signal Intelligence{% endblock %}

{% block content %}
<div class="grid-container">
    <!-- Summary Cards -->
    <div class="card glass">
        <div class="card-header">
            Total AI Signals
            <span class="material-symbols-outlined" style="color: var(--gold);">history</span>
        </div>
        <div class="main-price" id="total_signals" style="margin: 15px 0;">--</div>
        <div class="sub-price">Historical logs recorded</div>
    </div>

    <div class="card glass">
        <div class="card-header">
            Market Sentiment Bias
            <span class="material-symbols-outlined" style="color: var(--gold);">bullseye</span>
        </div>
        <div class="main-price" id="win_rate" style="margin: 15px 0;">--</div>
        <div class="sub-price">Weighted by >0.1% volatility</div>
    </div>

    <div class="card glass">
        <div class="card-header">
            Signal Weight Distribution
            <span class="material-symbols-outlined" style="color: var(--gold);">pie_chart</span>
        </div>
        <div style="height: 100px; display: flex; align-items: center; justify-content: center; margin-top: 10px;">
            <canvas id="signalDistChart"></canvas>
        </div>
    </div>

    <!-- Signal Log Table -->
    <div class="card glass grid-span-full">
        <div class="card-header">
            Signal Intelligence Archive
        </div>
        <div class="forecast-table-container">
            <table class="forecast-table" id="signalTable">
                <thead>
                    <tr>
                        <th>Observation Date</th>
                        <th>Recommended Action</th>
                        <th>Outcome</th>
                        <th>Confidence (%)</th>
                        <th>Observation Price (USD/oz)</th>
                        <th>Target Price (USD/oz)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5" class="text-center text-muted">Synchronizing signal history...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const response = await fetch('/api/signals_history');
            const data = await response.json();

            // Update Metrics
            const total = data.length;
            const totalEl = document.getElementById('total_signals');
            if (totalEl) totalEl.innerText = total;

            // Signal Distribution Counts
            let counts = { 'BUY': 0, 'SELL': 0, 'ACCUMULATE': 0, 'REDUCE': 0, 'HOLD': 0, 'WAIT': 0 };
            data.forEach(r => {
                const s = r.Signal.toUpperCase();
                if (counts[s] !== undefined) counts[s]++;
            });

            // Render Chart
            const chartCanvas = document.getElementById('signalDistChart');
            if (chartCanvas) {
                const ctx = chartCanvas.getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Bullish', 'Bearish', 'Neutral'],
                        datasets: [{
                            data: [
                                counts['BUY'] + counts['ACCUMULATE'],
                                counts['SELL'] + counts['REDUCE'],
                                counts['HOLD'] + counts['WAIT']
                            ],
                            backgroundColor: ['#4caf50', '#f44336', '#9e9e9e'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        cutout: '70%'
                    }
                });
            }

            // Calculate Sentiment Bias
            const bullish = counts['BUY'] + counts['ACCUMULATE'];
            const bearish = counts['SELL'] + counts['REDUCE'];
            let biasText = "Neutral";
            if (bullish > bearish) biasText = "Bullish";
            if (bearish > bullish) biasText = "Bearish";

            const winRateEl = document.getElementById('win_rate');
            if (winRateEl) winRateEl.innerText = biasText;

            // Render Table
            const tbody = document.querySelector('#signalTable tbody');
            if (tbody) {
                tbody.innerHTML = '';
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No signal data available for this period.</td></tr>';
                    return;
                }

                data.forEach(row => {
                    const tr = document.createElement('tr');

                    // Signal Badge
                    let badgeClass = 'risk-med';
                    const sig = row.Signal.toUpperCase();
                    if (sig === 'BUY' || sig === 'ACCUMULATE') badgeClass = 'risk-low';
                    if (sig === 'SELL' || sig === 'REDUCE') badgeClass = 'risk-high';

                    // Outcome Badge
                    let outcomeBadge = 'risk-med';
                    let outcomeText = row.Outcome || 'Pending';
                    if (outcomeText === 'Correct') outcomeBadge = 'risk-low';
                    if (outcomeText === 'Wrong') outcomeBadge = 'risk-high';
                    if (outcomeText === 'Expired') outcomeBadge = 'risk-med';

                    tr.innerHTML = `
                        <td>${row.Date}</td>
                        <td><span class="risk-indicator ${badgeClass}">${row.Signal}</span></td>
                        <td><span class="risk-indicator ${outcomeBadge}">${outcomeText}</span></td>
                        <td>${row.Confidence}</td>
                        <td>$${row.Price_USD.toLocaleString()}</td>
                        <td>$${row.Predicted_USD.toLocaleString()}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        } catch (e) {
            console.error("Error synchronizing signals:", e);
        }
    });
</script>
{% endblock %}