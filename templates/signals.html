{% extends "base.html" %}

{% block title %}Signal Intelligence | Gold Futures Pro{% endblock %}

{% block header_title %}Signal Intelligence{% endblock %}

{% block content %}
<div class="grid-container">
    <!-- Summary Cards -->
    <div class="card glass">
        <div class="card-header">
            Total AI Signals
            <span class="material-symbols-outlined" style="color: var(--gold);">history</span>
        </div>
        <div class="main-price" id="total_signals" style="margin: 15px 0;">--</div>
        <div class="sub-price">Historical logs recorded</div>
    </div>

    <div class="card glass">
        <div class="card-header">
            Signal Accuracy (Win Rate)
            <span class="material-symbols-outlined" style="color: var(--gold);">check_circle</span>
        </div>
        <div class="main-price" id="win_rate" style="margin: 15px 0;">--%</div>
        <div class="sub-price">Correct vs Total Completed</div>
    </div>

    <div class="card glass">
        <div class="card-header">
            Outcome Distribution
            <span class="material-symbols-outlined" style="color: var(--gold);">donut_large</span>
        </div>
        <div style="height: 100px; display: flex; align-items: center; justify-content: center; margin-top: 10px;">
            <canvas id="signalDistChart"></canvas>
        </div>
    </div>

    <!-- Signal Log Table -->
    <div class="card glass grid-span-full">
        <div class="card-header">
            Signal Intelligence Archive
        </div>
        <div class="forecast-table-container">
            <table class="forecast-table" id="signalTable">
                <thead>
                    <tr>
                        <th>Target Date</th>
                        <th>Recommended Action</th>
                        <th>Outcome</th>
                        <th>Confidence (%)</th>
                        <th>Signal Price (USD)</th>
                        <th>Forecast Price (USD)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5" class="text-center text-muted">Synchronizing signal history...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const response = await fetch('/api/signals_history');
            const data = await response.json();

            // Update Metrics
            const total = data.length;
            const totalEl = document.getElementById('total_signals');
            if (totalEl) totalEl.innerText = total;

            // Calculate Outcomes
            let outcomes = { 'Correct': 0, 'Wrong': 0, 'Pending': 0, 'Expired': 0 };
            data.forEach(r => {
                const o = r.Outcome || 'Pending';
                if (outcomes[o] !== undefined) outcomes[o]++;
                else outcomes['Pending']++; // Fallback
            });

            // Calculate Win Rate
            const completed = outcomes['Correct'] + outcomes['Wrong'];
            let winRate = 0;
            if (completed > 0) {
                winRate = (outcomes['Correct'] / completed) * 100;
            }

            const winRateEl = document.getElementById('win_rate');
            if (winRateEl) {
                winRateEl.innerText = `${Math.round(winRate)}%`;
                // Color code
                if (winRate >= 60) winRateEl.style.color = 'var(--fluorescent-green)';
                else if (winRate >= 50) winRateEl.style.color = '#fff';
                else winRateEl.style.color = 'var(--fluorescent-red)';
            }

            // Render Chart (Outcome Distribution)
            const chartCanvas = document.getElementById('signalDistChart');
            if (chartCanvas) {
                const ctx = chartCanvas.getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Correct', 'Wrong', 'Pending'],
                        datasets: [{
                            data: [
                                outcomes['Correct'],
                                outcomes['Wrong'],
                                outcomes['Pending'] + outcomes['Expired']
                            ],
                            backgroundColor: ['#00ff9d', '#ff3b3b', '#757575'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        cutout: '70%'
                    }
                });
            }

            // Render Table
            const tbody = document.querySelector('#signalTable tbody');
            if (tbody) {
                tbody.innerHTML = '';
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No signal data available for this period.</td></tr>';
                    return;
                }

                data.forEach(row => {
                    const tr = document.createElement('tr');

                    // Signal Badge
                    let badgeClass = 'risk-med';
                    const sig = row.Signal.toUpperCase();
                    if (sig === 'BUY' || sig === 'ACCUMULATE') badgeClass = 'risk-low';
                    if (sig === 'SELL' || sig === 'REDUCE') badgeClass = 'risk-high';

                    // Outcome Badge
                    let outcomeBadge = 'risk-med';
                    let outcomeText = row.Outcome || 'Pending';
                    if (outcomeText === 'Correct') outcomeBadge = 'risk-low';
                    if (outcomeText === 'Wrong') outcomeBadge = 'risk-high';
                    if (outcomeText === 'Expired') outcomeBadge = 'risk-med';

                    // Formatting Helper
                    const fmt = (num) => num ? `$${num.toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 1 })}` : '-';

                    tr.innerHTML = `
                        <td>${row.Date}</td>
                        <td><span class="risk-indicator ${badgeClass}">${row.Signal}</span></td>
                        <td><span class="risk-indicator ${outcomeBadge}">${outcomeText}</span></td>
                        <td>${row.Confidence}</td>
                        <td>${fmt(row.Price_USD)}</td>
                        <td>${fmt(row.Predicted_USD)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        } catch (e) {
            console.error("Error synchronizing signals:", e);
        }
    });
</script>
{% endblock %}